{
  "tasks": {
    "clobber": {
      "name": "clobber",
      "category": "30.maintain",
      "description": "hard resets to HEAD of origin and cleans the local repo",
      "env": {
        "BRANCH": "$(git branch --show-current)"
      },
      "steps": [
        {
          "exec": "git checkout -b scratch",
          "name": "save current HEAD in \"scratch\" branch"
        },
        {
          "exec": "git checkout $BRANCH"
        },
        {
          "exec": "git fetch origin",
          "name": "fetch latest changes from origin"
        },
        {
          "exec": "git reset --hard origin/$BRANCH",
          "name": "hard reset to origin commit"
        },
        {
          "exec": "git clean -fdx",
          "name": "clean all untracked files"
        },
        {
          "say": "ready to rock! (unpushed commits are under the \"scratch\" branch)"
        }
      ],
      "condition": "git diff --exit-code > /dev/null"
    },
    "test": {
      "name": "test",
      "category": "10.test",
      "description": "Run tests for tilediiif.* packages.",
      "steps": [
        {
          "spawn": "test:tilediiif.core"
        },
        {
          "spawn": "test:tilediiif.tools"
        },
        {
          "spawn": "test:tilediiif.server"
        }
      ]
    },
    "typecheck-python": {
      "name": "typecheck-python",
      "category": "30.maintain",
      "description": "Check Python types for tilediiif.* packages.",
      "steps": [
        {
          "spawn": "typecheck-python:tilediiif.core"
        },
        {
          "spawn": "typecheck-python:tilediiif.tools"
        },
        {
          "spawn": "typecheck-python:tilediiif.server"
        }
      ]
    },
    "format-python-code": {
      "name": "format-python-code",
      "category": "30.maintain",
      "description": "Format Python code of tilediiif.* packages.",
      "steps": [
        {
          "spawn": "format-python-code:tilediiif.core"
        },
        {
          "spawn": "format-python-code:tilediiif.tools"
        },
        {
          "spawn": "format-python-code:tilediiif.server"
        }
      ]
    },
    "create-release:tilediiif.core": {
      "name": "create-release:tilediiif.core",
      "category": "20.release",
      "description": "Generate a tagged release commit for tilediiif.core using standard-version",
      "steps": [
        {
          "exec": "npx standard-version --commit-all --path . --tag-prefix \"tilediiif.core-v\""
        }
      ],
      "condition": "test \"$(git status --porcelain)\" == \"\"",
      "cwd": "tilediiif.core"
    },
    "ensure-checkout-is-releaseable:tilediiif.core": {
      "name": "ensure-checkout-is-releaseable:tilediiif.core",
      "category": "20.release",
      "description": "Fail with an error if the working copy is not a clean checkout of a tilediiif.core release tag.",
      "steps": [
        {
          "exec": "        test \"$(git rev-parse HEAD)\" == \"$(git rev-parse tags/tilediiif.core-v0.1.0^{commit})\" \\\n          && test \"$(git status --porcelain)\" == \"\" \\\n          || (echo \"Error: the git checkout must be clean and tagged as tilediiif.core-v0.1.0\" 1>&2; exit 1)\n      "
        }
      ]
    },
    "typecheck-python:tilediiif.core": {
      "name": "typecheck-python:tilediiif.core",
      "category": "30.maintain",
      "description": "Typecheck tilediiif.core with mypy",
      "steps": [
        {
          "exec": "\\\n        cd \"tilediiif.core\" \\\n        && poetry run mypy --namespace-packages \\\n          -p tilediiif.core \\\n          -p tests"
        }
      ]
    },
    "format-python-code:tilediiif.core": {
      "name": "format-python-code:tilediiif.core",
      "category": "30.maintain",
      "description": "Format Python code of tilediiif.core.",
      "steps": [
        {
          "exec": "cd \"tilediiif.core\" && poetry run isort . ; poetry run black . ; poetry run flake8"
        }
      ]
    },
    "test:tilediiif.core": {
      "name": "test:tilediiif.core",
      "category": "10.test",
      "steps": [
        {
          "exec": "cd \"tilediiif.core\" && poetry run pytest"
        }
      ]
    },
    "create-release:tilediiif.tools": {
      "name": "create-release:tilediiif.tools",
      "category": "20.release",
      "description": "Generate a tagged release commit for tilediiif.tools using standard-version",
      "steps": [
        {
          "exec": "npx standard-version --commit-all --path . --tag-prefix \"tilediiif.tools-v\""
        }
      ],
      "condition": "test \"$(git status --porcelain)\" == \"\"",
      "cwd": "tilediiif.tools"
    },
    "ensure-checkout-is-releaseable:tilediiif.tools": {
      "name": "ensure-checkout-is-releaseable:tilediiif.tools",
      "category": "20.release",
      "description": "Fail with an error if the working copy is not a clean checkout of a tilediiif.tools release tag.",
      "steps": [
        {
          "exec": "        test \"$(git rev-parse HEAD)\" == \"$(git rev-parse tags/tilediiif.tools-v0.1.0^{commit})\" \\\n          && test \"$(git status --porcelain)\" == \"\" \\\n          || (echo \"Error: the git checkout must be clean and tagged as tilediiif.tools-v0.1.0\" 1>&2; exit 1)\n      "
        }
      ]
    },
    "typecheck-python:tilediiif.tools": {
      "name": "typecheck-python:tilediiif.tools",
      "category": "30.maintain",
      "description": "Typecheck tilediiif.tools with mypy",
      "steps": [
        {
          "exec": "\\\n        cd \"tilediiif.tools\" \\\n        && poetry run mypy --namespace-packages \\\n          -p tilediiif.tools \\\n          -p tests -p integration_tests"
        }
      ]
    },
    "format-python-code:tilediiif.tools": {
      "name": "format-python-code:tilediiif.tools",
      "category": "30.maintain",
      "description": "Format Python code of tilediiif.tools.",
      "steps": [
        {
          "exec": "cd \"tilediiif.tools\" && poetry run isort . ; poetry run black . ; poetry run flake8"
        }
      ]
    },
    "test:tilediiif.tools": {
      "name": "test:tilediiif.tools",
      "category": "10.test",
      "steps": [
        {
          "exec": "cd \"tilediiif.tools\" && poetry run pytest"
        }
      ]
    },
    "create-release:tilediiif.server": {
      "name": "create-release:tilediiif.server",
      "category": "20.release",
      "description": "Generate a tagged release commit for tilediiif.server using standard-version",
      "steps": [
        {
          "exec": "npx standard-version --commit-all --path . --tag-prefix \"tilediiif.server-v\""
        }
      ],
      "condition": "test \"$(git status --porcelain)\" == \"\"",
      "cwd": "tilediiif.server"
    },
    "ensure-checkout-is-releaseable:tilediiif.server": {
      "name": "ensure-checkout-is-releaseable:tilediiif.server",
      "category": "20.release",
      "description": "Fail with an error if the working copy is not a clean checkout of a tilediiif.server release tag.",
      "steps": [
        {
          "exec": "        test \"$(git rev-parse HEAD)\" == \"$(git rev-parse tags/tilediiif.server-v0.1.0^{commit})\" \\\n          && test \"$(git status --porcelain)\" == \"\" \\\n          || (echo \"Error: the git checkout must be clean and tagged as tilediiif.server-v0.1.0\" 1>&2; exit 1)\n      "
        }
      ]
    },
    "typecheck-python:tilediiif.server": {
      "name": "typecheck-python:tilediiif.server",
      "category": "30.maintain",
      "description": "Typecheck tilediiif.server with mypy",
      "steps": [
        {
          "exec": "\\\n        cd \"tilediiif.server\" \\\n        && poetry run mypy --namespace-packages \\\n          -p tilediiif.server \\\n          -p tests"
        }
      ]
    },
    "format-python-code:tilediiif.server": {
      "name": "format-python-code:tilediiif.server",
      "category": "30.maintain",
      "description": "Format Python code of tilediiif.server.",
      "steps": [
        {
          "exec": "cd \"tilediiif.server\" && poetry run isort . ; poetry run black . ; poetry run flake8"
        }
      ]
    },
    "test:tilediiif.server": {
      "name": "test:tilediiif.server",
      "category": "10.test",
      "steps": [
        {
          "exec": "cd \"tilediiif.server\" && poetry run pytest"
        }
      ]
    },
    "create-release:docker:tilediiif.tools-slim": {
      "name": "create-release:docker:tilediiif.tools-slim",
      "category": "20.release",
      "description": "Generate a tagged release commit for docker:tilediiif.tools-slim using standard-version",
      "steps": [
        {
          "exec": "npx standard-version --commit-all --path . --tag-prefix \"docker/tilediiif.tools-slim-v\""
        }
      ],
      "condition": "test \"$(git status --porcelain)\" == \"\"",
      "cwd": "docker/images/tilediiif.tools-slim"
    },
    "build-docker-image:tilediiif.tools-slim": {
      "name": "build-docker-image:tilediiif.tools-slim",
      "category": "00.build",
      "env": {
        "GIT_DIR": "$(git rev-parse --git-common-dir)",
        "VERSION_CHECKOUT": "$(mktemp -d)"
      },
      "steps": [
        {
          "exec": "git worktree add --detach \"$VERSION_CHECKOUT\" \"docker/tilediiif.tools-slim-v0.1.0\" \\\n&& cd \"$VERSION_CHECKOUT\" \\\n&& docker image build \\\n  --file \"docker/images/tilediiif.tools-slim/Dockerfile\" \\\n  --tag \"ghcr.io/cambridge-collection/tilediiif.tools:v0.1.0-slim\" --tag \"ghcr.io/cambridge-collection/tilediiif.tools:v0.1-slim\" --tag \"ghcr.io/cambridge-collection/tilediiif.tools:v0-slim\" --tag \"ghcr.io/cambridge-collection/tilediiif.tools:image-v0.1.0-slim\" --tag \"ghcr.io/cambridge-collection/tilediiif.tools:image-v0.1-slim\" --tag \"ghcr.io/cambridge-collection/tilediiif.tools:image-v0-slim\" \\\n  --build-arg \"TILEDIIIF_TOOLS_SHA=tags/tilediiif.tools-v0.1.0\" --build-arg \"TILEDIIIF_CORE_SHA=tags/tilediiif.core-v0.1.0\" \\\n  --label \"org.opencontainers.image.version=0.1.0 (tilediiif.tools=0.1.0, tilediiif.core=0.1.0)\" --label \"org.opencontainers.image.revision=$(git rev-parse --verify HEAD)\" --label \"org.opencontainers.image.title=tilediiif.tools slim\" --label \"org.opencontainers.image.description=The tilediiif.tools Python package.\" \\\n   \\\n  \"$GIT_DIR\" \\\n&& cd - \\\n&& git worktree remove \"$VERSION_CHECKOUT\""
        }
      ],
      "condition": "! docker image inspect ghcr.io/cambridge-collection/tilediiif.tools:v0.1.0-slim ghcr.io/cambridge-collection/tilediiif.tools:v0.1-slim ghcr.io/cambridge-collection/tilediiif.tools:v0-slim ghcr.io/cambridge-collection/tilediiif.tools:image-v0.1.0-slim ghcr.io/cambridge-collection/tilediiif.tools:image-v0.1-slim ghcr.io/cambridge-collection/tilediiif.tools:image-v0-slim > /dev/null 2>&1"
    },
    "push-docker-image:tilediiif.tools-slim": {
      "name": "push-docker-image:tilediiif.tools-slim",
      "category": "20.release",
      "steps": [
        {
          "spawn": "build-docker-image:tilediiif.tools-slim"
        },
        {
          "exec": "docker image push ghcr.io/cambridge-collection/tilediiif.tools:v0.1.0-slim ghcr.io/cambridge-collection/tilediiif.tools:v0.1-slim ghcr.io/cambridge-collection/tilediiif.tools:v0-slim ghcr.io/cambridge-collection/tilediiif.tools:image-v0.1.0-slim ghcr.io/cambridge-collection/tilediiif.tools:image-v0.1-slim ghcr.io/cambridge-collection/tilediiif.tools:image-v0-slim"
        }
      ]
    },
    "create-release:docker:tilediiif.tools-parallel": {
      "name": "create-release:docker:tilediiif.tools-parallel",
      "category": "20.release",
      "description": "Generate a tagged release commit for docker:tilediiif.tools-parallel using standard-version",
      "steps": [
        {
          "exec": "npx standard-version --commit-all --path . --tag-prefix \"docker/tilediiif.tools-parallel-v\""
        }
      ],
      "condition": "test \"$(git status --porcelain)\" == \"\"",
      "cwd": "docker/images/tilediiif.tools-parallel"
    },
    "build-docker-image:tilediiif.tools-parallel": {
      "name": "build-docker-image:tilediiif.tools-parallel",
      "category": "00.build",
      "env": {
        "GIT_DIR": "$(git rev-parse --git-common-dir)",
        "VERSION_CHECKOUT": "$(mktemp -d)"
      },
      "steps": [
        {
          "exec": "git worktree add --detach \"$VERSION_CHECKOUT\" \"docker/tilediiif.tools-parallel-v0.1.0\" \\\n&& cd \"$VERSION_CHECKOUT\" \\\n&& docker image build \\\n  --file \"docker/images/tilediiif.tools-parallel/Dockerfile\" \\\n  --tag \"ghcr.io/cambridge-collection/tilediiif.tools:v0.1.0\" --tag \"ghcr.io/cambridge-collection/tilediiif.tools:v0.1\" --tag \"ghcr.io/cambridge-collection/tilediiif.tools:v0\" --tag \"ghcr.io/cambridge-collection/tilediiif.tools:image-v0.1.0\" --tag \"ghcr.io/cambridge-collection/tilediiif.tools:image-v0.1\" --tag \"ghcr.io/cambridge-collection/tilediiif.tools:image-v0\" \\\n  --build-arg \"TILEDIIIF_TOOLS_SHA=tags/tilediiif.tools-v0.1.0\" --build-arg \"TILEDIIIF_CORE_SHA=tags/tilediiif.core-v0.1.0\" \\\n  --label \"org.opencontainers.image.version=0.1.0 (tilediiif.tools=0.1.0, tilediiif.core=0.1.0)\" --label \"org.opencontainers.image.revision=$(git rev-parse --verify HEAD)\" --label \"org.opencontainers.image.title=tilediiif.tools parallel\" --label \"org.opencontainers.image.description=The tilediiif.tools Python package, plus GNU parallel.\" \\\n   \\\n  \"$GIT_DIR\" \\\n&& cd - \\\n&& git worktree remove \"$VERSION_CHECKOUT\""
        }
      ],
      "condition": "! docker image inspect ghcr.io/cambridge-collection/tilediiif.tools:v0.1.0 ghcr.io/cambridge-collection/tilediiif.tools:v0.1 ghcr.io/cambridge-collection/tilediiif.tools:v0 ghcr.io/cambridge-collection/tilediiif.tools:image-v0.1.0 ghcr.io/cambridge-collection/tilediiif.tools:image-v0.1 ghcr.io/cambridge-collection/tilediiif.tools:image-v0 > /dev/null 2>&1"
    },
    "push-docker-image:tilediiif.tools-parallel": {
      "name": "push-docker-image:tilediiif.tools-parallel",
      "category": "20.release",
      "steps": [
        {
          "spawn": "build-docker-image:tilediiif.tools-parallel"
        },
        {
          "exec": "docker image push ghcr.io/cambridge-collection/tilediiif.tools:v0.1.0 ghcr.io/cambridge-collection/tilediiif.tools:v0.1 ghcr.io/cambridge-collection/tilediiif.tools:v0 ghcr.io/cambridge-collection/tilediiif.tools:image-v0.1.0 ghcr.io/cambridge-collection/tilediiif.tools:image-v0.1 ghcr.io/cambridge-collection/tilediiif.tools:image-v0"
        }
      ]
    },
    "create-release:docker:tilediiif-dev": {
      "name": "create-release:docker:tilediiif-dev",
      "category": "20.release",
      "description": "Generate a tagged release commit for docker:tilediiif-dev using standard-version",
      "steps": [
        {
          "exec": "npx standard-version --commit-all --path . --tag-prefix \"docker/tilediiif-dev-v\""
        }
      ],
      "condition": "test \"$(git status --porcelain)\" == \"\"",
      "cwd": "docker/images/dev"
    },
    "build-docker-image:tilediiif-dev": {
      "name": "build-docker-image:tilediiif-dev",
      "category": "00.build",
      "env": {
        "GIT_DIR": "$(git rev-parse --git-common-dir)",
        "VERSION_CHECKOUT": "$(mktemp -d)"
      },
      "steps": [
        {
          "exec": "git worktree add --detach \"$VERSION_CHECKOUT\" \"docker/tilediiif-dev-v0.1.0\" \\\n&& cd \"$VERSION_CHECKOUT\" \\\n&& docker image build \\\n  --file \"docker/images/dev/Dockerfile\" \\\n  --tag \"ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1.0-tools\" --tag \"ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1-tools\" --tag \"ghcr.io/cambridge-collection/tilediiif/dev-environment:v0-tools\" \\\n   \\\n  --label \"org.opencontainers.image.version=0.1.0\" --label \"org.opencontainers.image.revision=$(git rev-parse --verify HEAD)\" --label \"org.opencontainers.image.title=tilediiif development environment.\" \\\n  --target \"tools-dev\" \\\n  \"$VERSION_CHECKOUT\" \\\n&& docker image build \\\n  --file \"docker/images/dev/Dockerfile\" \\\n  --tag \"ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1.0-tools-without-mozjpeg\" --tag \"ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1-tools-without-mozjpeg\" --tag \"ghcr.io/cambridge-collection/tilediiif/dev-environment:v0-tools-without-mozjpeg\" \\\n  --build-arg \"VIPS_USE_MOZJPEG=\" \\\n  --label \"org.opencontainers.image.version=0.1.0\" --label \"org.opencontainers.image.revision=$(git rev-parse --verify HEAD)\" --label \"org.opencontainers.image.title=tilediiif development environment (without mozjpeg installed).\" \\\n  --target \"tools-dev\" \\\n  \"$VERSION_CHECKOUT\" \\\n&& docker image build \\\n  --file \"docker/images/dev/Dockerfile\" \\\n  --tag \"ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1.0-tools-with-broken-mozjpeg\" --tag \"ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1-tools-with-broken-mozjpeg\" --tag \"ghcr.io/cambridge-collection/tilediiif/dev-environment:v0-tools-with-broken-mozjpeg\" \\\n   \\\n  --label \"org.opencontainers.image.version=0.1.0\" --label \"org.opencontainers.image.revision=$(git rev-parse --verify HEAD)\" --label \"org.opencontainers.image.title=tilediiif-dev-env (broken mozjpeg)\" --label \"org.opencontainers.image.description=tilediiif development environment (with vips built for mozjpeg, but mozjpeg unavailable).\" \\\n  --target \"tools-dev-with-broken-mozjpeg\" \\\n  \"$VERSION_CHECKOUT\" \\\n&& cd - \\\n&& git worktree remove \"$VERSION_CHECKOUT\""
        }
      ],
      "condition": "! docker image inspect ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1.0-tools ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1-tools ghcr.io/cambridge-collection/tilediiif/dev-environment:v0-tools ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1.0-tools-without-mozjpeg ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1-tools-without-mozjpeg ghcr.io/cambridge-collection/tilediiif/dev-environment:v0-tools-without-mozjpeg ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1.0-tools-with-broken-mozjpeg ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1-tools-with-broken-mozjpeg ghcr.io/cambridge-collection/tilediiif/dev-environment:v0-tools-with-broken-mozjpeg > /dev/null 2>&1"
    },
    "push-docker-image:tilediiif-dev": {
      "name": "push-docker-image:tilediiif-dev",
      "category": "20.release",
      "steps": [
        {
          "spawn": "build-docker-image:tilediiif-dev"
        },
        {
          "exec": "docker image push ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1.0-tools ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1-tools ghcr.io/cambridge-collection/tilediiif/dev-environment:v0-tools ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1.0-tools-without-mozjpeg ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1-tools-without-mozjpeg ghcr.io/cambridge-collection/tilediiif/dev-environment:v0-tools-without-mozjpeg ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1.0-tools-with-broken-mozjpeg ghcr.io/cambridge-collection/tilediiif/dev-environment:v0.1-tools-with-broken-mozjpeg ghcr.io/cambridge-collection/tilediiif/dev-environment:v0-tools-with-broken-mozjpeg"
        }
      ]
    },
    "foobar": {
      "name": "foobar",
      "steps": [
        {
          "exec": "echo $(git log -1 --pretty=format:%h -- .projenrc.js) a b c"
        }
      ]
    }
  },
  "//": "~~ Generated by projen. To modify, edit .projenrc.js and run \"npx projen\"."
}
